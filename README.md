
# Firmware build for Zynq and ZynqMP SOC
 
# Сборка базовых компонент системы без Petalinux

Для систем на базе процессоров Zynq компания Xilinx предлагает
использовать Petalinux - фрэймворк построенный на основе
Yocto Project и OpenEmbedded. При этом вы получаете на выходе
все необходимые компоненты для загрузки и работы устройства:

- **FSBL**
- **u-boot**
- **linux kernel**
- **device-tree**
- **bitstream**
- **root filesystem**
    
Данная инструкция предлагает альернативный вариант сборки всех 
перечисленных программных компонент. Cформирована на основе 
материалов из wiki: 
[ZCU102 Image creation in OSL flow](https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841722/ZCU102+Image+creation+in+OSL+flow).
Существенным преимуществом данного подхода является ускорение процесса сборки с 
возможностью быстрой модификации любых программных компонент, а также с сохранением 
всех промежуточных результатов. Работа ведется с самыми актуальными исходными кодами
компонент. Недостаток - при возникновении проблем их придется решать самостоятельно.
Как правило возникают из-за несогласованности версий исходных кодов **Vivado/u-boot/linux/dts**.

# Программное обеспечение

- **Vitis 2020.2**
- **Vivado 2020.2**
- **git**
- **sed**
- **make**
- **mkimage**
    
# Подготовка среды для работы

Если у вас отсутствует утилита gmake, то в качестве первого шага необходимо создать 
символьную ссылку на **make**:

***cd /usr/bin && sudo ln -sv make gmake***
 
так как утилитам Xilinx при обработке tcl-скрипта требуется gmake.

## Загрузка каталога проекта

Корневой каталог проекта содержит все набор файлов и скриптов для
генерации соответствующих программных компонент.

 *** git clone https://github.com/insys-projects/osl-xilinx.git ***
    
## Описание основных файлов и каталогов проекта

```
    osl-xilinx
    |
    ├── bin             - вспомогательные скрипты и бинарные файлы
    ├── Makefile        - основной файл с общими настройками проекта
    ├── Makefile.src    - управление исходниами
    ├── Makefile.zynq   - правила сборки для Zynq
    ├── Makefile.zynqmp - правила сборки для ZynqMP
    ├── README.md
    ├── src             - каталог с исходными файлами
    │   ├── *.xsa       - экспортированный файл проекта из Vivado. (Создает пользователь)
    │   ├── dts
    │   │   ├── fmc130e-v11.dts - dts-файлы верхнего уровня для всех модулей
    │   │   ├── fmc130e-v12.dts
    │   │   ├── fmc131v-v101.dts
    │   │   ├── fmc133v-v12.dts
    │   │   ├── fmc138m-v11.dts
    │   │   └── fmc144v-v10.dts
    │   ├── dtsi                    - dtsi-файлы для всех модулей
    │   │   ├── fmc130e-axidev.dtsi - dtsi-файл для PL логики с поддержкой AXI-DMA
    │   │   ├── fmc130e.dtsi        
    │   │   ├── fmc130e-zdev.dtsi   - dtsi-файл для PL логики с поддержкой IS-DMA
    │   │   ├── fmc131v.dtsi
    │   │   ├── fmc133v.dtsi
    │   │   ├── fmc138m.dtsi
    │   │   └── fmc144v.dtsi
    │   └── kernel                  - файлы для формирования FIT-образов ядра linux
    │       ├── arm
    │       │   ├── fit-kernel-full.its
    │       │   └── fit-kernel.its
    │       └── arm64
    │           ├── fit-kernel-full.its
    │           └── fit-kernel.its
    └── xsct_script.tcl             - файл для генерации программных компонент Xilinx
```
# Описание основных параметров *Makefile*

Структура *Makefile* верхнего уровня приведена ниже:

```
    BOARD ?= fmc130e
    BOARD_VER ?= v11

    SOC_TYPE ?= zynq
    HDF_EXT ?= xsa

    SHELL := /bin/bash
    TOOLS_ROOT ?= /opt/xilinx
    TOOLS ?= $(TOOLS_ROOT)/Vitis
    VERSION ?= 2020.2
    MAKE := make
    MKDIR := mkdir
    SRC_DIR := $(HOME)/xilsrc
    SRC_VER := master
    EXT := $(HDF_EXT)

    include Makefile.$(SOC_TYPE)
    include Makefile.src
```
- **BOARD** - имя устройства для которого будет выполняться сборка проекта. Этот параметр
задает перфикс имени для каталогов создаваемых в процессе сборки. По значению **BOARD**
выбираются соответствующие группы файлов dtsi для формирования общего DTS.

- **BOARD_VER** - версия устройства для которого будет выполняться сборка проекта. Этот параметр
совместно с **BOARD** задает полное имя для общего файла DTS.

- **SOC_TYPE** - задает тип SOC. Возможные значения **zynq** и **zynqmp**.

- **HDF_EXT** - задает тип файла проекта экспортированного из Vivado. Возможные значения **hdf** и **xsa**. 
Версии Vivado до 2019.1 формировали **hdf**-файлы. Более поздние - **xsa**.

- **TOOLS_ROOT** - путь к установленым инструментальным средствам Xilinx: Vitis и Vivado

- **TOOLS** - путь к Vitis

- **VERSION** - версия инструментальных средств Xilinx. Используется 2020.2.

- **SRC_DIR** - каталог с исходными текстами из git-репозиториев.

- **SRC_VER** - версия исходных текстов на которую переключтся git-репозиторий.

# Описание *Makefile.src*

В **Makefile.src** определяются следущие цели:

- **get_sources** - выполнить клонирование репозиториев с исходными текстами 
в каталог **SRC_DIR** и переключить их на версию **SRC_VER**.

- **src_links** - выполнить создание символьных ссылок в корневой директории проекта на
соответствующие каталоги исходных текстов в директории **SRC_DIR**. Это сделано для того, 
чтобы исключить дубирование каталогов с исходными текстами для разных модулей или проектов.

- **update_src** - обновить исходники и переключить их версии на **SRC_VER**.

# Описание *Makefile.zynq*

В **Makefile.zynq** определяются следущие цели:

- **zynq_dts** - выполняет генерацию файлов с описанием дерева устройств DTS. 
Полученные файлы создаются в директории **BOARD**-dts. При этом может быть выполнена 
дополнительная обработка dtsi-файлов с помощью **sed**. В каталог **BOARD**-dts копируются
файлы пользователя из директорий: ./src/dts и ./src/dtsi по шаблону. 
Полученный набор dts/dtsi файлов копируется в директорию: u-boot-xlnx/arh/arm/dts.

- **zynq_dtb** - выполняет компиляцию файлов с описанием дерева устройств DTS в бинарный формат DTB.
Полученный dtb-файл используется для загрузки ядра linux и для формирования FIT-образа ядра.

- **fsbl** - на основе **HDF_EXT**-файла выполняет генерацию проекта для первичного загрузчика 
First Stage Boot Loader. Проект создается в директории **BOARD**-fsbl. Затем выполняется его сборка.
Бинарный файл **executable.elf** копируется в директорию ./bin c именем **zynq_fsbl.elf**

- **uboot** - выполняет сборку вторичного загрузчика **u-boot**. Для того чтобы в образ загрузчика
был встроен DTB файл для целевого устройства, с помощью **sed** корректируем **u-boot-xlnx/arh/arm/dts/Makefile**.
В него добавляется цель: **BOARD-BOARD_VER.dtb**. Собрка выполняется в каталоге **BOARD-uboot** не 
затрагивая исходники (кроме DTB-Makefile).

- **linux** -
- **bitconv** -
- **boot.bin.tiny** -
- **image.ub.ramfs** -
- **image.ub.sd** -

# Сборка компонент

## Подготовка дерева исходных текстов

Устанавливаем в Makefile переменные *SRC_DIR* и *SRC_VER*. Устанавливаем тип файла проекта *HDF_EXT*.
Выполняем команду:

***make get_sources***
    
После выполнения в директории *SRC_DIR* будут находится клонированные репозитории с исходными текстами 
linux, uboot и т.д. Далее необходимо создать символьные ссылки на репозитори, чтобы не дублировать каталоги 
с исходниками. Для этого выполняем команду:

***make src_links***

## Генерация dts и сборка dtb

***make zynq_dtb***

## Генерация и сборка fsbl

***make fsbl***

## Генерация и сборка u-boot

***make uboot***

## Генерация и сборка linux kernel

***make linux***

## Генерация image.ub.sd

***make image.ub.sd***

## Генерация BOOT.BIN

***make boot.bin.tiny***

Полученный файл **BOOT.BIN** содержит только: **zynq_fsbl.elf** и **u-boot.elf**

## Описание *Makefile.zynqmp*

В **Makefile.zynqmp** определяются следущие цели:

